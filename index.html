<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Géo-Navigation KMZ ChgptV1.6</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        #map { height: 400px; border-radius: 0.5rem; cursor: default; }
        #map.drawing-mode { cursor: crosshair; }
        button:disabled, .disabled-button {
            background-color: #9ca3af !important;
            cursor: not-allowed !important;
            opacity: 0.7;
        }
        #notification-banner { z-index: 1000; }
        #progress-bar { transition: width 0.5s ease-in-out; }
    </style>
</head>
<body class="bg-gray-100 font-sans p-4 md:p-6">

    <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-lg p-6 space-y-6">
        <header class="text-center">
            <h1 class="text-3xl font-bold text-gray-800">Géo-Navigation KMZ ChgptV1.6</h1>
            <p class="text-gray-500 mt-1">Enregistrez, créez, exportez et suivez vos parcours.</p>
        </header>

        <div id="map-section">
            <div id="map" class="w-full z-0"></div>
        </div>

        <div id="main-controls" class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <button id="draw-path-btn" class="bg-yellow-500 text-white py-2 px-4 rounded">Créer Parcours</button>
            <button id="edit-path-btn" class="bg-orange-500 text-white py-2 px-4 rounded" disabled>Éditer Parcours</button>
        </div>

        <div id="draw-controls" class="hidden">
            <p class="text-center text-blue-600 font-semibold mb-2">Mode création : cliquez pour ajouter, clic droit pour supprimer, glissez pour déplacer.</p>
            <div class="flex justify-center gap-4">
                <button id="confirm-draw-btn" class="bg-green-500 text-white py-2 px-4 rounded">Valider</button>
                <button id="cancel-draw-btn" class="bg-red-500 text-white py-2 px-4 rounded">Annuler</button>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();

        let map;
        let recordedPath = [];
        let recordedPolyline;

        let drawnPath = [];
        let drawnPolyline;
        let drawnMarkers = [];

        const drawBtn = document.getElementById('draw-path-btn');
        const confirmDrawBtn = document.getElementById('confirm-draw-btn');
        const cancelDrawBtn = document.getElementById('cancel-draw-btn');
        const editBtn = document.getElementById('edit-path-btn');

        function initMap() {
            map = L.map('map').setView([48.8566, 2.3522], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap'
            }).addTo(map);
            map.on('click', onMapClick);
        }

        function startDrawing() {
            if (recordedPolyline) map.removeLayer(recordedPolyline);
            recordedPolyline = null;
            document.getElementById('main-controls').classList.add('hidden');
            document.getElementById('draw-controls').classList.remove('hidden');
            map.getContainer().classList.add('drawing-mode');
        }

        function stopDrawing(savePath) {
            if (savePath && drawnPath.length > 0) {
                recordedPath = [...drawnPath];
                if (recordedPolyline) map.removeLayer(recordedPolyline);
                recordedPolyline = L.polyline(recordedPath, { color: 'red' }).addTo(map);
            } else if (recordedPath.length > 0) {
                recordedPolyline = L.polyline(recordedPath, { color: 'red' }).addTo(map);
            }

            if (drawnPolyline) map.removeLayer(drawnPolyline);
            drawnMarkers.forEach(m => map.removeLayer(m));
            drawnPath = [];
            drawnPolyline = null;
            drawnMarkers = [];

            document.getElementById('main-controls').classList.remove('hidden');
            document.getElementById('draw-controls').classList.add('hidden');
            map.getContainer().classList.remove('drawing-mode');

            editBtn.disabled = recordedPath.length === 0;
        }

        function onMarkerDrag(e) {
            const draggedMarker = e.target;
            const index = drawnMarkers.indexOf(draggedMarker);
            if (index > -1) {
                drawnPath[index] = [draggedMarker.getLatLng().lat, draggedMarker.getLatLng().lng];
                if (drawnPolyline) drawnPolyline.setLatLngs(drawnPath);
            }
        }

        function onMapClick(e) {
            if (!map.getContainer().classList.contains('drawing-mode')) return;
            const latLng = [e.latlng.lat, e.latlng.lng];
            drawnPath.push(latLng);

            const marker = L.marker(latLng, {
                draggable: true,
                icon: L.divIcon({
                    className: "custom-waypoint",
                    html: '<div style="width:12px;height:12px;background:#f97316;border:2px solid orange;border-radius:50%;"></div>',
                    iconSize: [12, 12],
                    iconAnchor: [6, 6]
                })
            }).addTo(map);

            marker.on('contextmenu', deleteDrawnPoint);
            marker.on('drag', onMarkerDrag);

            drawnMarkers.push(marker);

            if (!drawnPolyline) {
                drawnPolyline = L.polyline(drawnPath, { color: 'orange', dashArray: '5, 10' }).addTo(map);
            } else {
                drawnPolyline.addLatLng(latLng);
            }
        }

        function deleteDrawnPoint(e) {
            const markerToDelete = e.target;
            const index = drawnMarkers.indexOf(markerToDelete);
            if (index > -1) {
                drawnMarkers.splice(index, 1);
                drawnPath.splice(index, 1);
                map.removeLayer(markerToDelete);
                if (drawnPolyline) drawnPolyline.setLatLngs(drawnPath);
            }
        }

        drawBtn.addEventListener('click', () => {
            drawnPath = [];
            startDrawing();
        });
        confirmDrawBtn.addEventListener('click', () => stopDrawing(true));
        cancelDrawBtn.addEventListener('click', () => stopDrawing(false));

        editBtn.addEventListener('click', () => {
            if (recordedPath.length > 0) {
                drawnPath = [...recordedPath];
                if (drawnPolyline) map.removeLayer(drawnPolyline);
                drawnPolyline = L.polyline(drawnPath, { color: 'orange', dashArray: '5,10' }).addTo(map);

                drawnMarkers = drawnPath.map(p => {
                    const m = L.marker(p, {
                        draggable: true,
                        icon: L.divIcon({
                            className: "custom-waypoint",
                            html: '<div style="width:12px;height:12px;background:#f97316;border:2px solid orange;border-radius:50%;"></div>',
                            iconSize: [12, 12],
                            iconAnchor: [6, 6]
                        })
                    }).addTo(map);
                    m.on('contextmenu', deleteDrawnPoint);
                    m.on('drag', onMarkerDrag);
                    return m;
                });
                startDrawing();
            }
        });

        window.onload = () => {
            initMap();
        };
    </script>
</body>
</html>
